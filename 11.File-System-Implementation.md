# Chapter 11: File-System Implementation

## File-System Structure

File systems provide efficient and convenient access to the disk by allowing data to be stored, located, and retrieved easily.

A file system is composed of many different levels.
-   The **I/O control level** consists of device drivers and interrupt handlers to transfer information between the main memory and the disk system.
-   The **basic file system** needs only to issue generic commands to the appropriate device driver to read and write physical blocks on the disk.
-   The **file-organization module** knows about files and their logical blocks, as well as physical blocks.
-   The **logical file system** manages metadata information. Metadata includes all of the file-system structure, except for the actual data (or contents of the file).

## File-System Implementation

### On-Disk Structures

A file system can be stored on a disk. Most disks are divided into one or more partitions, with each partition containing a file system.

-   **Boot control block:** Contains information needed by the system to boot an operating system from that partition.
-   **Partition control block:** Contains partition details, such as the number of blocks in the partition, the size of the blocks, a free-block count, and free-block pointers.
-   **Directory structure:** Used to organize the files.
-   **File control block (FCB):** Contains many of the details about the file, such as file permissions, ownership, size, and location of the data blocks.

### In-Memory Structures

The in-memory structures are used for file-system management and for performance improvement via caching.

-   **In-memory partition table:** Contains information about each mounted partition.
-   **In-memory directory structure:** Holds the directory information of recently accessed directories.
-   **System-wide open-file table:** Contains a copy of the FCB of each open file, as well as other information.
-   **Per-process open-file table:** Contains a pointer to the appropriate entry in the system-wide open-file table.

## Directory Implementation

The directory is a symbol table that maps file names to their FCBs.

-   **Linear List:** The simplest method of implementing a directory is to use a linear list of file names with pointers to the data blocks.
-   **Hash Table:** A hash table can be used to speed up the search for a file in a directory.

## Allocation Methods

An important aspect of file-system implementation is how to allocate space to files so that disk space is utilized effectively and files can be accessed quickly.

-   **Contiguous Allocation:** Requires that each file occupy a set of contiguous blocks on the disk.
-   **Linked Allocation:** Each file is a linked list of disk blocks; the disk blocks may be scattered anywhere on the disk.
-   **Indexed Allocation:** Brings all the pointers together into one location: the index block.

## Free-Space Management

Since disk space is limited, we need to reuse the space from deleted files for new files, if possible. To keep track of free disk space, the system maintains a **free-space list**.

-   **Bit Vector:** The free-space list is often implemented as a bit map or bit vector. Each block is represented by 1 bit. If the block is free, the bit is 1; if the block is allocated, the bit is 0.
-   **Linked List:** The free disk blocks are linked together.
-   **Grouping:** A modification of the linked-list approach is to store the addresses of n free blocks in the first free block.
-   **Counting:** We can keep the address of the first free block and the number of free contiguous blocks that follow the first block.

## Efficiency and Performance

Efficiency of a file system is dependent on the disk allocation and directory algorithms in use.

-   **Efficiency:** Depends on the amount of disk space used per file.
-   **Performance:** Depends on the time it takes to access the data.

**Caching:** To improve performance, most systems cache disk blocks in memory.

## Recovery

Since all file data, as well as the file-system structure, are stored on disk, we must ensure that the data are not lost in case of a system crash.

-   **Consistency Checking:** The `fsck` command in UNIX is used to check for file-system consistency.
-   **Log-Structured File Systems:** A log-structured file system (LFS) is a file system in which data and metadata are written sequentially to a circular buffer, called a log.
-   **Backup and Restore:** The file system should be backed up periodically.

## NFS

The **Network File System (NFS)** is a protocol that allows a user on a client computer to access files over a computer network much like local storage is accessed.
